<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout | Top Pie Pizzeria</title>
  <style>
    :root { --accent:#fc6e51; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 24px; background:#fafafa; }
    h1 { color: var(--accent); margin: 0 0 16px; }
    .cart { background:#fff; border:1px solid #eee; border-radius:12px; padding:16px; max-width:800px; }
    .row { display:grid; grid-template-columns: 1fr auto auto auto; gap:12px; align-items:center; padding:12px 0; border-bottom:1px solid #f0f0f0; }
    .row:last-child { border-bottom:none; }
    .item-name { font-weight:600; }
    .qty { opacity:0.8; }
    .price { font-variant-numeric: tabular-nums; }
    .remove, .btn { cursor:pointer; border:none; border-radius:10px; padding:10px 14px; }
    .remove { background:#f5f5f5; }
    .remove:hover { background:#eee; }
    .footer { display:flex; justify-content:space-between; align-items:center; margin-top:12px; }
    .total { font-size:1.1rem; font-weight:700; }
    .btn { background:var(--accent); color:#fff; }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
    .empty { padding:24px; text-align:center; color:#666; }
    .note { margin-top:10px; font-size:0.9rem; color:#666; }
  </style>
</head>
<body>
  <h1><strong>Your Cart</strong></h1>

  <div id="cart" class="cart">
    <div id="cart-items" class="items"></div>

    <div id="cart-empty" class="empty" style="display:none;">
      Your cart is empty.
    </div>

    <div class="footer" id="cart-footer" style="display:none;">
      <div class="total">Subtotal: <span id="subtotal">$0.00</span></div>
      <button id="checkout-btn" class="btn">Checkout</button>
    </div>

    <div class="note">Tip: items and totals are loaded from your cart API.</div>
  </div>

  <script type="module">
    // Ensure a stable client identifier for cart association
    function ensureClientId() {
      let id = localStorage.getItem('clientId');
      if (!id) {
        id = 'demo-user'; // replace with a UUID if you prefer
        localStorage.setItem('clientId', id);
      }
      return id;
    }

    const clientId = ensureClientId();
    const itemsRoot = document.getElementById('cart-items');
    const emptyEl   = document.getElementById('cart-empty');
    const footerEl  = document.getElementById('cart-footer');
    const subtotalEl= document.getElementById('subtotal');
    const checkoutBtn = document.getElementById('checkout-btn');

    async function loadCart() {
      itemsRoot.innerHTML = '';
      emptyEl.style.display = 'none';
      footerEl.style.display = 'none';
      checkoutBtn.disabled = true;

      try {
        const res = await fetch(`/api/cart?clientId=${encodeURIComponent(clientId)}`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load cart');
        const data = await res.json();
        const cart = data.cart ?? data.items ?? []; // support either shape
        const subtotal = Number(data.subtotal ?? calcSubtotal(cart));

        if (!cart.length) {
          emptyEl.style.display = 'block';
          return;
        }

        itemsRoot.innerHTML = cart.map(item => {
          const id = item.pizzaId ?? item.id ?? '';
          const name = item.name ?? 'Pizza';
          const qty = Number(item.quantity ?? 1);
          const price = Number(item.price ?? 0);
          return `
            <div class="row" data-id="${id}">
              <div class="item-name">${escapeHtml(name)}</div>
              <div class="qty">x${qty}</div>
              <div class="price">$${(price * qty).toFixed(2)}</div>
              <button class="remove" data-action="remove">Remove</button>
            </div>
          `;
        }).join('');

        subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
        footerEl.style.display = 'flex';
        checkoutBtn.disabled = false;
      } catch (e) {
        itemsRoot.innerHTML = `<div class="empty">Unable to load cart. Please try again.</div>`;
      }
    }

    function calcSubtotal(cart) {
      return cart.reduce((s, it) => s + Number(it.price ?? 0) * Number(it.quantity ?? 1), 0);
    }

    // Very small HTML escape to avoid issues with item names
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    // Event delegation for remove buttons
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-action="remove"]');
      if (!btn) return;

      const row = btn.closest('.row');
      const pizzaId = row?.dataset.id;
      if (!pizzaId) return;

      btn.disabled = true;

      try {
        const res = await fetch('/api/cart/remove', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ clientId, pizzaId })
        });
        if (!res.ok) throw new Error('Remove failed');

        // Optimistic UI: remove row, then refresh totals
        row.remove();
        // If no more items, show empty state; else reload to recalc subtotal
        if (!itemsRoot.querySelector('.row')) {
          emptyEl.style.display = 'block';
          footerEl.style.display = 'none';
        } else {
          await loadCart();
        }
      } catch (err) {
        btn.disabled = false;
        alert('Failed to remove item. Please try again.');
      }
    });

    // Checkout button – wire to your flow (stripe, order create, etc.)
    checkoutBtn.addEventListener('click', async () => {
      // Example: POST /api/orders or navigate to payment
      // location.href = '/payment';
      alert('Proceeding to checkout… (wire this up to your payment flow)');
    });

    loadCart();
  </script>
</body>
</html>
